# -*- coding:utf-8 -*-
from zs_backend import SqlOperate
from zs_backend.busi import busi
from zs_backend.utils.common import login_require
from flask import render_template, session, request, jsonify, g
from zs_backend.utils import time_util
from zs_backend.utils.channel_qry import *
import json

ACTIVITY_TYPE_FIX = 6  ## 固定额度赠送
ACTIVITY_TYPE_PERCENT = 7  ## 充值百分比赠送
# 活动类型映射
activity_type_map = {
    6: u'固定金额赠送',
    7: u'充值金额的百分比赠送'
}

# 参与玩家映射
PARTICIPATION_TYPE_ALL = 1  ## 所有玩家
PARTICIPATION_TYPE_NEW = 2  ## 新玩家
PARTICIPATION_TYPE_OLD = 3  ## 老玩家
participation_member_map = {
    1: u'所有玩家',
    2: u'新玩家',
    3: u'老玩家'
}

# # 状态对应数字
is_delete = 0
pass_audit = 1
wait_audit = 2
# # 状态映射
# status_map = {
#     0: u'下线',
#     1: u'已审核',
#     2: u'待审核'
# }

# 状态映射
TAKE_EFFECT = 1  # 生效
LOSE_EFFICACY = 0  # 失效
status_map = {
    1: u'生效',
    0: u'失效'
}


@busi.route('/recharge/discounts/show', methods=['GET'])
@login_require
def recharge_discounts_show(tips='', status_msg=dict(), data=list()):
    """充值优惠设置页面"""

    # 其他信息
    other_msg = dict()
    other_msg['beginDate'] = status_msg.get('begin_time', 11)
    other_msg['endDate'] = status_msg.get('end_time', 11)
    other_msg['SelectChannel'] = status_msg.get('channel_id', '')
    other_msg['tips'] = tips
    other_msg['OThers'] = [u'<td> 活动描述：<input type="text" id="activity_title_retrieve" '
                           u'name="activity_title" value="%s"> </td>' % status_msg.get('activity_title', ''),
                           u'<td> 后台账号ID：<input type="text" id="user_id_retrieve" '
                           u'name="user_id" value="%s"> </td>' % status_msg.get('user_id', '')]
    channels = session.get('channel')

    # # 高级用户可以操作通过审核按钮
    # is_high_level_user = False
    # if session.get('access_level') == 1:
    #     is_high_level_user = True

    # 返回模版与数据
    return render_template('recharge_discounts.html', other_msg=other_msg, channels=channels, data=data)


@busi.route('/recharge/discounts/retrieve', methods=['GET'])
@login_require
def recharge_discounts_retrieve():
    """充值优惠设置查询"""

    # 获取参数
    channel_id = session['select_channel']
    activity_content = request.args.get('activity_title')
    user_id = request.args.get('user_id')
    begin_time = request.args.get('beginDate')
    end_time = request.args.get('endDate')

    # 状态参数
    status_msg = dict()
    status_msg['channel_id'] = int(channel_id)
    status_msg['activity_title'] = activity_content
    status_msg['user_id'] = user_id
    status_msg['begin_time'] = time_util.formatDatestamp(begin_time)
    status_msg['end_time'] = time_util.formatDatestamp(end_time)

    # 校验并处理参数
    where = ''
    if user_id:
        try:
            int(user_id)
        except ValueError:
            return recharge_discounts_show(tips=u'后台账号ID必须为整数纯数字！', status_msg=status_msg)
        where += " AND user_id=%s" % user_id
    if activity_content:
        where += " AND activity_content like '%%%s%%'" % activity_content
    begin_time = time_util.formatDatestamp(begin_time)
    end_time = time_util.formatDatestamp(end_time)

    # 从数据库获取数据
    retrieve_sql = """SELECT priority,id,user_id,activity_content,activity_type,
                              participation_member,request_times,max_add_recharge,journal_require,begin_time,
                              end_time,status
                      FROM admin_recharge_discounts
                      WHERE ((begin_time>=%s AND begin_time<=%s)
                      OR (end_time>=%s AND end_time<=%s))
                        %s
                      ORDER BY status DESC;""" \
                   % (begin_time, end_time, begin_time, end_time, where)
    data = LogQry(channel_id).qry(retrieve_sql)

    # 处理数据
    data_list = list()
    for priority, activity_id, user_id, activity_content, activity_type, \
        participation_member, request_times, max_add_recharge, journal_require, begin_time, \
        end_time, status in data:
        data_dict = dict()
        data_dict['priority'] = priority
        data_dict['activity_id'] = activity_id
        data_dict['user_id'] = user_id
        data_dict['activity_content'] = activity_content.replace('\n', '<br>')
        data_dict['activity_type'] = activity_type_map[activity_type]
        data_dict['participation_member'] = participation_member_map[participation_member]
        data_dict['request_times'] = request_times
        data_dict['max_add_recharge'] = max_add_recharge if max_add_recharge else ''
        data_dict['journal_require'] = journal_require
        data_dict['begin_time'] = time_util.formatDateTime(begin_time)
        data_dict['end_time'] = time_util.formatDateTime(end_time)
        if status == TAKE_EFFECT:  # 如果状态为生效，再判断一下当前时间与活动实际时间是否生效，若失效则修改状态
            if not begin_time < time_util.now_sec() < end_time:
                status = LOSE_EFFICACY
                update_sql = """UPDATE admin_recharge_discounts
                                SET status=%s
                                WHERE id=%s;""" \
                             % (status, activity_id)
                LogQry(channel_id).execute(update_sql)
        data_dict['status'] = status_map[status]
        data_dict['status_num'] = status  # 用于调字体颜色
        data_list.append(data_dict)

    # 返回模版与数据
    return recharge_discounts_show(status_msg=status_msg, data=data_list)


@busi.route('/recharge/discounts/create/update', methods=['POST'])
@login_require
def recharge_discounts_create_update():
    """充值优惠设置新建/修改"""

    # 获取参数
    channel_id = session['select_channel']
    user_id = g.user_id
    activity_title = request.form.get('activity_title')
    show_picture_url = request.form.get('show_picture_url')
    tab1_url = request.form.get('tab1_url')
    tab2_url = request.form.get('tab2_url')
    activity_type = request.form.get('activity_type')
    participation_member = request.form.get('participation_member')
    participation_level = request.form.get('participation_level')
    activity_content = request.form.get('activity_content')
    recharge_detail = request.form.get('recharge_detail')
    journal_require = request.form.get('journal_require')
    request_times = request.form.get('request_times')
    max_add_recharge = request.form.get('max_add_recharge')
    begin_time = request.form.get('begin_time')
    end_time = request.form.get('end_time')
    priority = request.form.get('priority')
    activity_id = request.form.get('activity_id')

    # 校验并处理参数
    if not all([begin_time, end_time, priority, activity_content]):
        return jsonify(result=0, msg=u'请输入所有必填项！')
    try:
        int(priority)
        int(journal_require)
        int(request_times)
        max_add_recharge = int(max_add_recharge) * 100
    except ValueError:
        return jsonify(result=0, msg=u'流水要求、申请次数、最高赠送、优先级为整数纯数字！')
    try:
        recharge_detail = eval(recharge_detail)
    except Exception:
        return jsonify(result=0, msg=u'所有充值梯度里的项都是必填项，且为整数纯数字！')
    for one in recharge_detail:
        i = 0
        for one_in_one in one:
            try:
                one[i] = int(one_in_one) * 100
            except ValueError:
                return jsonify(result=0, msg=u'所有充值梯度里的项都是必填项，且为整数纯数字！')
            i += 1
    if participation_level == ']':
        participation_level = ''
    begin_time = time_util.formatTimestamp(begin_time)
    end_time = time_util.formatTimestamp(end_time)
    if begin_time > end_time:
        return jsonify(result=0, msg=u'开始时间不能大于结束时间！')

    # 向游戏服发送请求
    times = [begin_time] + [end_time]
    game_status = GameWeb(channel_id).post('/api/up_activity',
                                           {'id': int(activity_type), 'icon1': tab1_url, 'icon2': tab2_url,
                                            'mark': activity_title, 'ord': int(priority), 'detail': show_picture_url,
                                            'times': times, 'rules': activity_content})
    if game_status['result'] != 'ok':
        return jsonify(result=0, msg='创建失败！')

    # 根据当前时间判定新建的活动的状态
    if begin_time < time_util.now_sec() < end_time:
        status = TAKE_EFFECT
    else:
        status = LOSE_EFFICACY

    # 新建充值优惠
    if not activity_id:
        # 先把同活动类型为生效状态的活动改状态为失效
        update_sql = """UPDATE admin_recharge_discounts
                        SET status=%s
                        WHERE status=%s
                        AND activity_type=%s;""" \
                     % (LOSE_EFFICACY, TAKE_EFFECT, activity_type)
        LogQry(channel_id).execute(update_sql)
        # 再新建新的活动
        create_sql = """INSERT INTO admin_recharge_discounts
                        VALUES (0,%s,%s,'%s','%s',%s,
                                %s,'%s','%s','%s',%s,
                                %s,'%s','%s',%s,%s,
                                %s,%s);""" \
                     % (user_id, priority, activity_title, activity_content, activity_type,
                        participation_member, show_picture_url, tab1_url, tab2_url, begin_time,
                        end_time, participation_level, recharge_detail, request_times, max_add_recharge,
                        journal_require, status)
        LogQry(channel_id).execute(create_sql)
        return jsonify(result=1, msg=u'新建成功！')

    # 修改充值优惠
    else:
        # 先把同活动类型为生效状态的活动改状态为失效
        update_sql = """UPDATE admin_recharge_discounts
                        SET status=%s
                        WHERE status=%s
                        AND activity_type=%s;""" \
                     % (LOSE_EFFICACY, TAKE_EFFECT, activity_type)
        LogQry(channel_id).execute(update_sql)
        # 再修改活动
        update_sql = """UPDATE admin_recharge_discounts
                        SET priority=%s,activity_title='%s',activity_content='%s',activity_type=%s,participation_member=%s,
                            show_picture_url='%s',tab1_url='%s',tab2_url='%s',begin_time=%s,end_time=%s,
                            participation_level='%s',recharge_detail='%s',request_times=%s,max_add_recharge=%s,journal_require=%s,
                            status=%s
                        WHERE id=%s;""" \
                     % (priority, activity_title, activity_content, activity_type, participation_member,
                        show_picture_url, tab1_url, tab2_url, begin_time, end_time,
                        participation_level, recharge_detail, request_times, max_add_recharge, journal_require,
                        status, activity_id)
        LogQry(channel_id).execute(update_sql)
        return jsonify(result=1, msg=u'修改成功！')


# @busi.route('/recharge/discounts/audit', methods=['PUT'])
# @login_require
# def recharge_discounts_audit():
#     """充值优惠设置通过审核"""
#
#     # 获取参数
#     activity_id = request.form.get('activity_id')
#
#     # 更新数据库的邮件状态
#     update_sql = """UPDATE admin_recharge_discounts
#                     SET status=%s
#                     WHERE id=%s;""" \
#                  % (pass_audit, int(activity_id))
#     LogQry(session['select_channel']).execute(update_sql)
#
#     # 返回应答
#     return jsonify(msg=u'id为%s的活动已通过审核！' % activity_id)


@busi.route('/recharge/discounts/json', methods=['GET'])
@login_require
def recharge_discounts_json():
    """返回修改充值优惠设置的json数据"""

    # 获取参数
    activity_id = request.args.get('activity_id')

    # 从数据库获取数据
    retrieve_sql = """SELECT activity_type,activity_title,show_picture_url,tab1_url,tab2_url,
                              activity_content,participation_member,participation_level,journal_require,request_times,
                              max_add_recharge,recharge_detail,begin_time,end_time,priority
                      FROM admin_recharge_discounts
                      WHERE id=%s;""" % activity_id
    data = LogQry(session['select_channel']).qry(retrieve_sql)

    # 处理数据
    data = data[0]
    data_dict = dict()
    data_dict['activity_type'] = data[0]
    data_dict['activity_title'] = data[1]
    data_dict['show_picture_url'] = data[2]
    data_dict['tab1_url'] = data[3]
    data_dict['tab2_url'] = data[4]
    data_dict['activity_content'] = data[5]
    data_dict['participation_member'] = data[6]
    data_dict['participation_level'] = data[7]
    data_dict['journal_require'] = data[8]
    data_dict['request_times'] = data[9]
    data_dict['max_add_recharge'] = data[10] / 100
    new_detail = eval(data[11])
    for one in new_detail:
        i = 0
        for one_in_one in one:
            one[i] = one_in_one / 100
            i += 1
    data_dict['recharge_detail'] = new_detail
    data_dict['begin_time'] = time_util.formatDateTime(data[12])
    data_dict['end_time'] = time_util.formatDateTime(data[13])
    data_dict['priority'] = data[14]
    data_dict['activity_id'] = activity_id

    # 返回数据
    return jsonify(data=data_dict)


# @busi.route('/recharge/discounts/cancel', methods=['PUT'])
# @login_require
# def recharge_discounts_cancel():
#     """充值优惠批量下线"""
#
#     # 获取参数
#     batch_list = request.form.get('batch_list')
#
#     # 校验并处理参数
#     try:
#         batch_list = eval(batch_list)
#     except SyntaxError:
#         return jsonify(result=0, msg=u'请勾选要下线的充值优惠！')
#
#     # 处理数据
#     cancel_id_str = '('
#     for cancel_id in batch_list:
#         cancel_id_str += str(cancel_id) + ','
#     else:
#         cancel_id_str = cancel_id_str.rstrip(',') + ')'
#
#     # 更新数据库
#     update_sql = """UPDATE admin_recharge_discounts SET status=%s WHERE id in %s;""" % \
#                  (is_delete, cancel_id_str)
#     LogQry(session['select_channel']).execute(update_sql)
#
#     # 返回应答
#     return jsonify(result=1, msg=u'id为%s的充值优惠已下线！' % cancel_id_str)


## 根据充值优惠获得最终充值所获得金币
## recharge 单位分
def get_coin_recharge_discounts(channel, recharge, pid):
    ## 查询当前是否有优惠活动
    Now = time_util.now_sec()
    sql = '''
        select id, participation_member, participation_level, activity_type, recharge_detail,
                request_times, max_add_recharge
        from admin_recharge_discounts
        where begin_time <= %d and end_time >= %d
        and status = %d
    ''' % (Now, Now, pass_audit)
    data = LogQry(channel).qry(sql)
    if not data:
        return 0, 0, recharge * 100

    ## 查询该玩家的所属层级
    sql = 'select vip, total_recharge_rmb from player where id = %d' % pid
    vip, is_recharge = LogQry(channel).qry(sql)[0]
    is_recharge = is_recharge > 0

    ## 计算玩家当前参与过的充值优惠情况
    got_recharge_discount = {}
    sql = '''
        select rechargeid, sum(add_recharge), count(1)
        from admin_recharge
        where pid = %d
        group by rechargeid
    ''' % pid
    for i, k, v in LogQry(channel).qry(sql):
        got_recharge_discount[int(i)] = {
            "total": int(k),
            "times": int(v),
        }

    # 遍历各个优惠活动 查找给予玩家最大利益的优惠
    can_get_discounts = {}
    for aid, participation_member, participation_level, activity_type, recharge_detail, \
        request_times, max_add_recharge in data:
        ## 先判断可参与玩家 以及 参与层级
        ## 如果只是针对新玩家 但是又已经充值了 则忽略
        if participation_member == PARTICIPATION_TYPE_NEW and is_recharge:
            continue
        if participation_member == PARTICIPATION_TYPE_OLD and (not is_recharge):
            continue
        ## 判断最大赠送金额
        if not max_add_recharge:
            max_add_recharge = 999999999999999999
        if got_recharge_discount.has_key(aid) and got_recharge_discount[aid]["total"] >= max_add_recharge:
            continue
        ## 判断最大可申请次数
        if got_recharge_discount.has_key(aid) and got_recharge_discount[aid]["times"] >= request_times:
            continue
        ## 玩家层级不在此部分
        if str(vip) not in participation_level.split(","):
            continue
        ## 判断活动可赠送的金额数 
        recharge_detail = eval(recharge_detail)
        recharge_detail.sort(reverse=True)
        ## 剩余可赠送金额 单位分
        if got_recharge_discount.has_key(aid):
            rest_add_recharge = max_add_recharge - got_recharge_discount[aid]["total"]
        else:
            rest_add_recharge = max_add_recharge
        ## 固定金额
        if activity_type == ACTIVITY_TYPE_FIX:
            for min_recharge, add_recharge in recharge_detail:
                if recharge >= min_recharge:
                    can_get_discounts[aid] = min(add_recharge, rest_add_recharge)
                    break
        ## 百分比
        elif activity_type == ACTIVITY_TYPE_PERCENT:
            for min_recharge, add_percent in recharge_detail:
                if recharge >= min_recharge:
                    can_get_discounts[aid] = min(int(recharge * add_percent / 10000), rest_add_recharge)
                    break

    print can_get_discounts
    ## 找不到可优惠的活动
    if not can_get_discounts:
        return 0, 0, recharge * 100

    ## 有可优惠的活动 则找到最大可赠送的
    final_add_recharge = 0
    final_recharge_id = 0
    for k, v in can_get_discounts.items():
        if v >= final_add_recharge:
            final_recharge_id = k
            final_add_recharge = v

    return final_recharge_id, final_add_recharge, (final_add_recharge + recharge) * 100
